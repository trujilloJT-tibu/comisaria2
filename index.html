<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA INTEGRAL - COMISAR√çA 2da ROSARIO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root {
            --primary: #0a192f;
            --accent: #1e3a8a;
            --text: #e2e8f0;
            --border: #334155;
            --success: #059669;
            --warning: #ca8a04;
        }

        /* DISE√ëO DE PANTALLA */
        @media screen {
            * { box-sizing: border-box; text-transform: uppercase; }
            body {
                background-color: var(--primary);
                color: var(--text);
                font-family: 'Segoe UI', Tahoma, sans-serif;
                margin: 0; padding: 20px;
                display: flex; flex-direction: column; align-items: center;
            }
            .container {
                width: 95%; max-width: 1200px;
                background: rgba(15, 23, 42, 0.95);
                padding: 30px; border-radius: 12px;
                border: 1px solid var(--border);
                box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            }
            h1 { text-align: center; color: #3b82f6; border-bottom: 2px solid var(--accent); padding-bottom: 10px; }
            .section-title {
                background: var(--accent); padding: 12px; margin-top: 25px;
                border-radius: 5px; font-weight: bold; border-left: 5px solid #3b82f6;
            }
            .grid-form {
                display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
                gap: 15px; margin-top: 15px;
            }
            .form-group { display: flex; flex-direction: column; }
            label { font-size: 0.75rem; color: #94a3b8; margin-bottom: 5px; font-weight: 600; }
            input, select, textarea {
                background: #1e293b; border: 1px solid var(--border);
                color: white; padding: 12px; border-radius: 6px;
                font-size: 0.95rem; transition: all 0.3s;
            }
            input:focus, textarea:focus { border-color: #3b82f6; outline: none; background: #26334d; }
            .full-row { grid-column: 1 / -1; }
            textarea { min-height: 100px; resize: vertical; }

            .print-panel {
                background: #1e3a8a; padding: 25px; border-radius: 10px;
                margin-top: 30px; border: 2px solid #3b82f6;
                display: flex; flex-direction: column; align-items: center;
            }
            .button-group { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
            button {
                cursor: pointer; padding: 12px 20px; border: none; border-radius: 6px;
                font-weight: bold; transition: all 0.3s; display: flex; align-items: center; gap: 8px;
            }
            button:hover { transform: translateY(-2px); filter: brightness(1.2); }
            .btn-save { background: var(--success); color: white; }
            .btn-blue { background: #3b82f6; color: white; }
            .btn-orange { background: #f59e0b; color: white; }
            .btn-purple { background: #8b5cf6; color: white; }
            .btn-pink { background: #db2777; color: white; }
            .btn-new { background: #475569; color: white; border: 1px solid #94a3b8; }
            
            table { width: 100%; border-collapse: collapse; margin-top: 30px; background: #0f172a; border-radius: 8px; overflow: hidden; }
            th { background: #1e3a8a; color: white; padding: 15px; text-align: left; }
            td { padding: 12px; border-bottom: 1px solid var(--border); }
            tr:hover { background: #1e293b; }
            #printArea { display: none; }

            #editorElevacion {
                width: 100%; min-height: 400px; background: white; color: black;
                padding: 20px; margin-top: 10px; border-radius: 5px;
                font-family: Arial, sans-serif; text-transform: none; overflow-y: auto;
            }
        }

        /* DISE√ëO DE IMPRESI√ìN */
        @media print {
            @page { size: A4; margin: 0; }
            body * { visibility: hidden; text-transform: uppercase; }
            #printArea, #printArea * { visibility: visible; }
            #printArea {
                display: block !important; position: absolute; left: 0; top: 0; width: 100%;
                color: black; background: white; padding: 0;
            }

            .print-ficha {
                padding-top: 1cm; margin-left: 6.5cm; width: 8cm;
                text-align: center; font-family: "Courier New", monospace;
                font-size: 11pt; line-height: 1.4; font-weight: bold;
            }
            .print-ficha div { min-height: 1.2em; margin-bottom: 2px; }

            .print-doc {
                padding: 1.5cm 2.2cm; font-family: Arial, Helvetica, sans-serif;
                font-size: 11pt; line-height: 1.5; color: black;
            }
            .p-fecha { text-align: right; margin-bottom: 35px; }
            .p-ref { display: flex; justify-content: space-between; margin-bottom: 35px; font-weight: bold; }
            .p-cuerpo { text-align: justify; text-indent: 5cm; margin-bottom: 20px; }
            .p-firma { margin-top: 60px; text-align: right; font-weight: bold; line-height: 1.2; }
            
            .print-acta {
                padding: 1.2cm 2cm; font-family: "Times New Roman", Times, serif;
                font-size: 10.5pt; text-align: justify; text-transform: none; line-height: 1.3;
            }
            .acta-titulo { text-align: center; font-weight: bold; text-decoration: underline; font-size: 13pt; margin-bottom: 15px; }
            .acta-punto { margin-bottom: 8px; padding-left: 10px; }

            .planilla-linea { border-bottom: 1px solid black; display: inline-block; min-width: 280px; text-transform: uppercase; }
            [contenteditable="true"] { border: none; outline: none; }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>‚úô COMISAR√çA 2da URII - ROSARIO ‚úô</h1>
        
        <form id="registroForm">
            <div class="section-title">üë§ IDENTIDAD DEL DEMORADO</div>
            <div class="grid-form">
                <div class="form-group"><label>Nombre y Apellido</label><input type="text" id="nombreCompleto"></div>
                <div class="form-group"><label>Apodo / Alias</label><input type="text" id="apodo" value="NO TIENE"></div>
                <div class="form-group"><label>DNI / Documento</label><input type="text" id="dni"></div>
                <div class="form-group"><label>Hijo de (Padre)</label><input type="text" id="padre"></div>
                <div class="form-group"><label>Hijo de (Madre)</label><input type="text" id="madre"></div>
                <div class="form-group"><label>Fecha de Nacimiento</label><input type="date" id="fechaNac"></div>
                <div class="form-group"><label>Edad</label><input type="text" id="edad"></div>
                <div class="form-group"><label>Estado Civil</label><input type="text" id="estadoCivil" value="SOLTERO"></div>
                <div class="form-group"><label>Nacionalidad</label><input type="text" id="nacionalidad" value="ARGENTINO"></div>
                <div class="form-group"><label>Domicilio Real</label><input type="text" id="domicilio"></div>
                <div class="form-group"><label>Ciudad</label><input type="text" id="ciudad" value="ROSARIO"></div>
                <div class="form-group"><label>Provincia</label><input type="text" id="provincia" value="SANTA FE"></div>
            </div>

            <div class="section-title">‚öñÔ∏è DATOS DE LA CAUSA Y BIENES</div>
            <div class="grid-form">
                <div class="form-group full-row"><label>Antecedentes Penales</label><textarea id="antecedentes"></textarea></div>
                <div class="form-group full-row"><label>Capturas y Paraderos</label><textarea id="capturas"></textarea></div>
                
                <div class="form-group"><label>Causa por la que lo traen</label><input type="text" id="causaIngreso"></div>
                <div class="form-group"><label>Calificaci√≥n Legal Final (Causa)</label><input type="text" id="causaFinal"></div>
                
                <div class="form-group"><label>Nombre V√≠ctima</label><input type="text" id="victima" value="LA SOCIEDAD"></div>
                <div class="form-group"><label>Domicilio V√≠ctima</label><input type="text" id="domicilioVictima"></div>
                
                <div class="form-group full-row"><label>Secuestro</label><textarea id="secuestro"></textarea></div>
                <div class="form-group full-row"><label>Pertenencias</label><textarea id="pertenencias"></textarea></div>

                <div class="form-group"><label>N√∫mero de Causa / CUIJ</label><input type="text" id="nroCausa"></div>
                <div class="form-group"><label>N√∫mero de Prio</label><input type="text" id="nroPrio"></div>
                <div class="form-group"><label>Fiscal√≠a Interviniente</label><input type="text" id="fiscalia"></div>
                <div class="form-group"><label>Fecha del Hecho</label><input type="date" id="fechaApreh"></div>
                <div class="form-group"><label>Oficial Sumariante</label><input type="text" id="sumariante" value="SUB OFICIAL TRUJILLO"></div>
                <div class="form-group"><label>Orden Judicial</label><input type="text" id="orden" value="QUEDA DETENIDO"></div>
                <input type="hidden" id="elevacionPersonalizada">
            </div>

            <div class="print-panel">
                <div class="button-group">
                    <button type="button" class="btn-save" onclick="guardarDato()">üíæ GUARDAR</button>
                    <button type="button" class="btn-blue" onclick="imprimir('ficha')">üñ®Ô∏è FICHA</button>
                    <button type="button" class="btn-orange" onclick="imprimir('planilla')">üìù PLANILLA</button>
                    <button type="button" class="btn-purple" onclick="imprimir('cotejo')">üìÑ COTEJO</button>
                    <button type="button" class="btn-purple" style="background:#4338ca" onclick="imprimir('afis')">üÜî AFIS</button>
                    <button type="button" class="btn-pink" onclick="imprimir('insercion')">üì• INSERCI√ìN</button>
                    <button type="button" class="btn-blue" onclick="imprimir('acta')">üìú DERECHOS</button>
                    
                    <button type="button" class="btn-new" onclick="imprimir('const_domicilio')">üè† CONST. DOM.</button>
                    <button type="button" class="btn-new" onclick="imprimir('prohibicion')">üö´ PROHIBICION</button>
                    <button type="button" class="btn-new" onclick="imprimir('entrega_rodado')">üèçÔ∏è ENT. RODADO</button>
                    <button type="button" class="btn-new" onclick="imprimir('nota_medico')">‚öïÔ∏è NOTA MEDICO</button>
                    <button type="button" class="btn-new" onclick="imprimir('notificacion')">üîî NOTIFICACION</button>
                    <button type="button" class="btn-new" onclick="imprimir('entrega_pert')">üì¶ ENT. PERTEN.</button>
                    
                    <button type="button" class="btn-save" style="background: #2563eb;" onclick="abrirEditorElevacion()">üìÑ ELEVACI√ìN</button>

                    <button type="button" class="btn-save" onclick="exportarExcel()">üìä EXCEL</button>
                    <button type="button" class="btn-new" onclick="document.getElementById('inputExcel').click()">üì• IMPORTAR EXCEL</button>

                    <input type="file" id="inputExcel" style="display:none" accept=".xlsx" onchange="leerExcel(this)">
                </div>
                <button type="button" onclick="limpiar()" style="margin-top:15px; background:#475569; color:white;">üßπ LIMPIAR</button>
            </div>
            
            <div id="contenedorEditor" style="display:none; margin-top:20px; width:100%;">
                <div class="section-title">üìù EDITAR TEXTO DE ELEVACI√ìN (PUEDE MODIFICAR AQU√ç)</div>
                <div id="editorElevacion" contenteditable="true"></div>
                <div class="button-group" style="margin-top:10px;">
                    <button type="button" class="btn-save" onclick="prepararImpresionElevacion()">üñ®Ô∏è CONFIRMAR E IMPRIMIR</button>
                    <button type="button" class="btn-new" onclick="document.getElementById('contenedorEditor').style.display='none'">‚ùå CANCELAR</button>
                </div>
            </div>
        </form>

        <table id="tablaRegistros">
            <thead>
                <tr>
                    <th>APREHENDIDO</th>
                    <th>DNI</th>
                    <th>DELITO</th>
                    <th>ACCIONES</th>
                </tr>
            </thead>
            <tbody id="cuerpoTabla"></tbody>
        </table>
    </div>

    <div id="printArea"></div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // 2. Tu configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDMjRk1c_UAmuU973dQu90cVTg-xqC_oYs",
            authDomain: "comisaria2da-sistema.firebaseapp.com",
            projectId: "comisaria2da-sistema",
            storageBucket: "comisaria2da-sistema.firebasestorage.app",
            messagingSenderId: "282597994707",
            appId: "1:282597994707:web:5ba83a9f37d747ee732426",
            measurementId: "G-ZHEBW6VFYF"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const dbCloud = firebase.firestore();

        let db = [];
        let indexEdit = null;

        // 3. Sincronizaci√≥n en tiempo real (Esencial para ver cambios de otras PCs)
        dbCloud.collection("registros").orderBy("timestamp", "desc")
            .onSnapshot((snapshot) => {
                db = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTabla();
            });

        // 4. Guardar en la Nube
        async function guardarDato() {
            const campos = document.querySelectorAll('#registroForm input, #registroForm textarea');
            const r = {};
            campos.forEach(c => r[c.id] = c.value.toUpperCase());
            
            r.timestamp = firebase.firestore.FieldValue.serverTimestamp();

            try {
                if (indexEdit !== null) {
                    const id = db[indexEdit].id;
                    await dbCloud.collection("registros").doc(id).update(r);
                    indexEdit = null;
                } else {
                    await dbCloud.collection("registros").add(r);
                }
                document.getElementById('registroForm').reset();
                alert("‚úÖ SINCRONIZADO CON √âXITO EN TODA LA RED");
            } catch (error) {
                alert("‚ùå ERROR: Verifique su conexi√≥n a internet.");
            }
        }

        // 5. Eliminar de la Nube
        async function eliminarDato(i) {
            if(confirm("¬øEST√Å SEGURO QUE DESEA ELIMINAR ESTE REGISTRO DE TODA LA RED?")) {
                const id = db[i].id;
                await dbCloud.collection("registros").doc(id).delete();
                indexEdit = null;
            }
        }

        // 6. Funciones de Renderizado y Carga
        function renderTabla() {
            const tbody = document.getElementById('cuerpoTabla');
            tbody.innerHTML = db.map((r, i) => `
                <tr>
                    <td>${r.nombreCompleto || ''}</td>
                    <td>${r.dni || ''}</td>
                    <td>${r.causaFinal || ''}</td>
                    <td>
                        <button onclick="cargar(${i})" style="background:var(--warning); color:white; padding:5px 10px;">EDITAR</button>
                        <button onclick="eliminarDato(${i})" style="background:#dc2626; color:white; padding:5px 10px; margin-left:5px;">ELIMINAR</button>
                    </td>
                </tr>
            `).join('');
        }

        function cargar(i) {
            indexEdit = i;
            const r = db[i];
            Object.keys(r).forEach(k => { if(document.getElementById(k)) document.getElementById(k).value = r[k]; });
            document.getElementById('contenedorEditor').style.display = 'none';
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function limpiar() { 
            document.getElementById('registroForm').reset(); 
            document.getElementById('contenedorEditor').style.display = 'none';
            indexEdit = null; 
        }

        function fF(f) { return f ? f.split('-').reverse().join('/') : ""; }
        
        function getHoy() {
            const d = new Date();
            const opciones = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
            return `ROSARIO, ${d.toLocaleDateString('es-AR', opciones)}`.toUpperCase();
        }

        // 7. Funciones de Elevaci√≥n e Impresi√≥n
        function abrirEditorElevacion() {
            const r = indexEdit !== null ? db[indexEdit] : null;
            if(!r) return alert("PRIMERO SELECCIONE UN REGISTRO DE LA TABLA (EDITAR)");
            const editor = document.getElementById('editorElevacion');
            const contenedor = document.getElementById('contenedorEditor');
            
            if(r.elevacionPersonalizada && r.elevacionPersonalizada.trim() !== "") {
                editor.innerHTML = r.elevacionPersonalizada;
            } else {
                const hoy = getHoy();
                editor.innerHTML = `
                    <div style="font-family: Arial; font-size: 11pt; line-height: 1.5;">
                        <div style="text-align: right;">${hoy}.-</div>
                        <p>MINISTERIO PUBLICO DE LA ACUSACION<br>FISCALIA DE FLAGRANCIA Y TURNO.<br>‚Äú FISCAL‚Äù</p>
                        <p>A.U.O.P.<br>Cr√≠a. 2da.<br>Nota Nro.________/26.- &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OBJETO: ELEVAR ACTUACIONES<br>Ref. CAUSA ‚Äú${r.nroCausa || ''}‚Äù/26</p>
                        <p style="text-align: justify; text-indent: 5cm;">Por medio de la presente elevo a Usted, en referencia a actuaciones por un hecho caratulado a prima facie "${r.causaFinal || ''}", en donde resultare victima la llamada "${r.victima || ''}" e imputado el llamado "${r.nombreCompleto || ''}" para su conocimiento, consideraci√≥n y dem√°s fines legales que estime corresponder.-</p>
                        <br><p>Saludo a Ud. muy atte.</p><br><br>
                        <div style="text-align: right;">${r.sumariante || ''}<br>COMISARIA 2¬∞ URII</div>
                    </div>`;
            }
            contenedor.style.display = 'block';
            window.scrollTo({top: contenedor.offsetTop, behavior: 'smooth'});
        }

        async function prepararImpresionElevacion() {
            const contenido = document.getElementById('editorElevacion').innerHTML;
            const id = db[indexEdit].id;
            await dbCloud.collection("registros").doc(id).update({ elevacionPersonalizada: contenido });
            const area = document.getElementById('printArea');
            area.innerHTML = `<div class="print-doc">${contenido}</div>`;
            window.print();
        }

        function imprimir(tipo) {
            const r = indexEdit !== null ? db[indexEdit] : db[0];
            if(!r) return alert("PRIMERO GUARDE O SELECCIONE UN REGISTRO");
            
            const area = document.getElementById('printArea');
            const fechaN = fF(r.fechaNac);
            const hoy = getHoy();

            // L√≥gica de impresi√≥n original mantenida
            if(tipo === 'ficha') {
                area.innerHTML = `<div class="print-ficha"><div>${r.nombreCompleto}</div><div style="margin-bottom:1.5em"></div><div>${r.padre}</div><div>${r.madre}</div><div>${r.nacionalidad}</div><div>${r.provincia}</div><div>${r.ciudad}</div><div>${fechaN} &nbsp; ${r.edad} A√ëOS</div><div>D.N.I. N¬∫ ${r.dni}</div><div style="margin-bottom:1.5em"></div><div>${r.domicilio}</div></div>`;
            } else if(tipo === 'planilla') {
                area.innerHTML = `<div class="print-doc"><div class="p-fecha">${hoy}</div><h2 style="text-align:center; text-decoration:underline;">PLANILLA DE FILIACION PRONTUARIAL</h2><p><strong>APELLIDO Y NOMBRES:</strong> <span class="planilla-linea">${r.nombreCompleto}</span></p><p><strong>DNI N¬∞:</strong> <span class="planilla-linea">${r.dni}</span></p><div style="margin-top:20px"><strong>ANTECEDENTES:</strong><pre>${r.antecedentes}</pre></div><div class="p-firma">${r.sumariante}<br>COMISARIA 2¬∞</div></div>`;
            } else if(tipo === 'acta') {
                area.innerHTML = `<div class="print-acta"><div class="acta-titulo">ACTA DE CONOCIMIENTO DE DERECHOS</div><p>En Rosario, a la fecha <strong>${hoy}</strong>, se notifica a <strong>${r.nombreCompleto}</strong> de sus derechos... imputado por <strong>${r.causaFinal}</strong>.</p><div class="p-firma">${r.sumariante}</div></div>`;
            } else if(tipo === 'entrega_pert') {
                area.innerHTML = `<div class="print-doc"><div class="p-fecha">${hoy}</div><h2 style="text-align:center; text-decoration:underline;">ACTA DE ENTREGA DE PERTENENCIAS</h2><div>Se hace entrega a <strong>${r.nombreCompleto}</strong> de: <strong>${r.pertenencias}</strong>.</div><div class="p-firma">${r.sumariante}</div></div>`;
            }
            window.print();
        }

        async function exportarExcel() {
            const wb = new ExcelJS.Workbook();
            const sh = wb.addWorksheet('REGISTRO_POLICIAL');
            sh.addRow(["NOMBRE", "DNI", "PADRE", "MADRE", "FECHA NAC", "CAUSA FINAL", "FISCALIA"]);
            db.forEach(r => sh.addRow([r.nombreCompleto, r.dni, r.padre, r.madre, fF(r.fechaNac), r.causaFinal, r.fiscalia]));
            const buffer = await wb.xlsx.writeBuffer();
            saveAs(new Blob([buffer]), "BASE_DATOS_COMISARIA_2DA.xlsx");
        }
    </script>
</body>
</html>