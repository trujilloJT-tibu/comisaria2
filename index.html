<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> COMISAR√çA 2da ROSARIO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root {
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --accent: #38bdf8;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border: #334155;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --ia-color: #8b5cf6;
        }

        /* --- DISE√ëO DE PANTALLA --- */
        @media screen {
            * { box-sizing: border-box; text-transform: uppercase; transition: all 0.2s ease; }
            
            body {
                background-color: var(--bg-main);
                color: var(--text-main);
                font-family: 'Inter', system-ui, -apple-system, sans-serif;
                margin: 0;
                padding: 10px;
                line-height: 1.5;
            }

            .container {
                width: 100%;
                max-width: 1300px;
                margin: 0 auto;
                padding: 15px;
            }

            header {
                text-align: center;
                padding: 20px 0;
                border-bottom: 1px solid var(--border);
                margin-bottom: 30px;
            }

            h1 {
                font-size: 1.8rem;
                letter-spacing: 2px;
                color: var(--accent);
                margin: 0;
                text-shadow: 0 0 15px rgba(56, 189, 248, 0.3);
            }

            .card {
                background: var(--bg-card);
                border-radius: 16px;
                border: 1px solid var(--border);
                padding: 24px;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                margin-bottom: 25px;
            }

            .section-title {
                display: flex;
                align-items: center;
                gap: 10px;
                font-size: 1rem;
                font-weight: 700;
                color: var(--text-main);
                margin-bottom: 20px;
                padding-bottom: 10px;
                border-bottom: 2px solid var(--primary);
            }

            .grid-form {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
                gap: 20px;
            }

            .form-group { display: flex; flex-direction: column; }
            
            label {
                font-size: 0.7rem;
                color: var(--text-muted);
                margin-bottom: 6px;
                font-weight: 700;
                letter-spacing: 0.5px;
            }

            input, select, textarea {
                background: #0f172a;
                border: 1px solid var(--border);
                color: #fff;
                padding: 12px 16px;
                border-radius: 8px;
                font-size: 0.9rem;
            }

            input:focus, textarea:focus {
                border-color: var(--primary);
                outline: none;
                box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
            }

            .full-row { grid-column: 1 / -1; }
            textarea { min-height: 80px; }

            .actions-panel {
                background: #231f57;
                border: 1px solid var(--primary);
                position: sticky;
                bottom: 20px;
                z-index: 100;
                display: flex;
                flex-direction: column;
                gap: 15px;
            }

            .button-group {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 8px;
                width: 100%;
            }

            button {
                cursor: pointer;
                padding: 10px 15px;
                border: none;
                border-radius: 8px;
                font-weight: 700;
                font-size: 0.75rem;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                color: white;
            }

            button:hover { transform: translateY(-2px); filter: brightness(1.1); }
            button:active { transform: translateY(0); }

            .btn-save { background: var(--success); grid-column: span 2; font-size: 1rem; }
            .btn-print { background: var(--primary); }
            .btn-secondary { background: #475569; }
            .btn-tool { background: #6366f1; }
            .btn-special { background: #db2777; }
            .btn-ia { background: var(--ia-color); }

            /* Sem√°foro de plazos */
            .status-timer { font-weight: bold; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; }
            .status-ok { background: #065f46; color: #34d399; }
            .status-warning { background: #92400e; color: #fbbf24; }
            .status-danger { background: #991b1b; color: #f87171; animation: blink 1s infinite; }
            @keyframes blink { 50% { opacity: 0.5; } }

            .table-container { overflow-x: auto; margin-top: 20px; border-radius: 12px; }
            table { width: 100%; border-collapse: collapse; background: var(--bg-card); }
            th { background: #334155; color: var(--text-main); padding: 15px; text-align: left; font-size: 0.8rem; }
            td { padding: 12px 15px; border-bottom: 1px solid var(--border); font-size: 0.85rem; }
            
            .fecha-header {
                background: #334155 !important;
                color: var(--accent);
                font-weight: bold;
                text-align: left;
                padding: 12px 20px;
                border-bottom: 2px solid var(--bg-main);
                display: flex;
                justify-content: space-between;
                align-items: center;
                user-select: none;
            }

            .check-cell { text-align: center; min-width: 45px; }
            .check-cell input { width: 18px; height: 18px; cursor: pointer; }

            #printArea { display: none; }

            #editorElevacion {
                width: 100%; min-height: 400px; background: white; color: black;
                padding: 40px; border-radius: 8px; font-family: Arial, sans-serif;
                text-transform: none; margin: 10px 0;
            }
        }

        /* --- DISE√ëO DE IMPRESI√ìN --- */
        @media print {
            @page { size: A4; margin: 0; }
            html, body { height: 99%; overflow: hidden; }
            body * { visibility: hidden; text-transform: uppercase; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { display: block !important; position: absolute; left: 0; top: 0; width: 100%; height: 100%; color: black; background: white; padding: 0; }
            .print-ficha { padding-top: 1cm; margin-left: 6.5cm; width: 8cm; text-align: center; font-family: "Courier New", monospace; font-size: 11pt; line-height: 1.4; font-weight: bold; }
            .print-planilla { padding: 1.5cm 2cm; font-family: Arial, Helvetica, sans-serif; font-size: 11pt; line-height: 1.6; color: black; }
            .print-doc { padding: 4cm 2cm 1cm 2cm; font-family: Arial, Helvetica, sans-serif; font-size: 11pt; line-height: 1.7; color: black; }
            .print-acta { padding: 4cm 2cm 1cm 2cm; font-family: "Times New Roman", Times, serif; font-size: 11pt; text-align: justify; text-transform: none; line-height: 1.5; }
            .p-fecha { text-align: right; margin-bottom: 25px; }
            .p-ref { display: flex; justify-content: space-between; margin-bottom: 25px; font-weight: bold; }
            .p-cuerpo { text-align: justify; text-indent: 3cm; margin-bottom: 20px; line-height: 1.7; }
            .p-firma { margin-top: 50px; text-align: right; font-weight: bold; line-height: 1.2; }
            pre { white-space: pre-wrap !important; word-wrap: break-word !important; font-size: 10pt !important; margin: 10px 0 !important; line-height: 1.4; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚úô COMISAR√çA 2da ROSARIO ‚úô</h1>
        </header>

        <div class="card" style="border: 2px solid var(--success); background: #0f172a;">
            <div class="section-title" style="color: var(--success); border-color: var(--success);">
                üì≤ IMPORTAR DESDE WHATSAPP (DATOS Y ANTECEDENTES)
            </div>
            <textarea id="rawInput" placeholder="Pega aqu√≠ el texto que te pasaron por WhatsApp..." style="width: 100%; min-height: 100px; margin-bottom: 10px; border-color: var(--success);"></textarea>
            <button type="button" onclick="procesarWhatsApp()" style="background: var(--success); width: 100%; font-size: 1rem;">
                ‚ö° INTERPRETAR Y CARGAR DATOS
            </button>
        </div>
        
        <form id="registroForm">
            <div class="card">
                <div class="section-title">üë§ IDENTIDAD DEL DEMORADO</div>
                <div class="grid-form">
                    <div class="form-group"><label>Nombre y Apellido</label><input type="text" id="nombreCompleto" placeholder="Ej: JUAN PEREZ"></div>
                    <div class="form-group"><label>Apodo / Alias</label><input type="text" id="apodo" value="NO TIENE"></div>
                    <div class="form-group"><label>DNI / Documento</label><input type="text" id="dni"></div>
                    <div class="form-group"><label>Hijo de (Padre)</label><input type="text" id="padre"></div>
                    <div class="form-group"><label>Hijo de (Madre)</label><input type="text" id="madre"></div>
                    <div class="form-group"><label>Fecha de Nacimiento</label><input type="date" id="fechaNac"></div>
                    <div class="form-group"><label>Edad</label><input type="text" id="edad"></div>
                    <div class="form-group"><label>Estado Civil</label><input type="text" id="estadoCivil" value="SOLTERO"></div>
                    <div class="form-group"><label>Nacionalidad</label><input type="text" id="nacionalidad" value="ARGENTINO"></div>
                    <div class="form-group"><label>Domicilio Real</label><input type="text" id="domicilio"></div>
                    <div class="form-group"><label>Ciudad</label><input type="text" id="ciudad" value="ROSARIO"></div>
                    <div class="form-group"><label>Provincia</label><input type="text" id="provincia" value="SANTA FE"></div>
                </div>
            </div>

            <div class="card">
                <div class="section-title">‚öñÔ∏è DATOS DE LA CAUSA Y BIENES</div>
                <div class="grid-form">
                    <div class="form-group full-row"><label>Antecedentes Penales</label><textarea id="antecedentes"></textarea></div>
                    <div class="form-group full-row"><label>Capturas y Paraderos</label><textarea id="capturas"></textarea></div>
                    <div class="form-group"><label>Causa por la que lo traen</label><input type="text" id="causaIngreso"></div>
                    <div class="form-group"><label>Calificaci√≥n Final</label><input type="text" id="causaFinal"></div>
                    <div class="form-group"><label>Nombre V√≠ctima</label><input type="text" id="victima" value="LA LLAMADA"></div>
                    <div class="form-group"><label>Domicilio V√≠ctima</label><input type="text" id="domicilioVictima"></div>
                    <div class="form-group full-row"><label>Secuestro</label><textarea id="secuestro"></textarea></div>
                    <div class="form-group full-row"><label>Pertenencias</label><textarea id="pertenencias"></textarea></div>
                    <div class="form-group"><label>NROCAUSA</label><input type="text" id="nroCausa"></div>
                    <div class="form-group"><label>N√∫mero de Prio</label><input type="text" id="nroPrio"></div>
                    <div class="form-group"><label>Fiscal√≠a</label><input type="text" id="fiscalia"></div>
                    <div class="form-group"><label>Fecha del Hecho</label><input type="date" id="fechaApreh"></div>
                    <div class="form-group"><label>Oficial Sumariante</label><input type="text" id="sumariante" value="SUB OFICIAL TRUJILLO"></div>
                    <div class="form-group"><label>Orden Judicial</label><input type="text" id="orden" value="RECUPERA SU LIBERTAD A TENOR DEL ART 218 CPP"></div>
                    <input type="hidden" id="elevacionPersonalizada">
                </div>
            </div>

            <div class="card actions-panel">
                <div class="section-title" style="margin-bottom:10px; border:none">‚ö° DOCUMENTACI√ìN</div>
                <div class="button-group">
                    <button type="button" class="btn-save" onclick="guardarDato()">üíæ GUARDAR EN RED</button>
                    <button type="button" class="btn-print" onclick="imprimir('ficha')">üñ®Ô∏è FICHA</button>
                    <button type="button" class="btn-print" onclick="imprimir('planilla')">üìù PLANILLA</button>
                    <button type="button" class="btn-print" onclick="imprimir('cotejo')">üìÑ COTEJO</button>
                    <button type="button" class="btn-print" style="background:#4338ca" onclick="imprimir('afis')">üÜî AFIS</button>
                    <button type="button" class="btn-special" onclick="imprimir('insercion')">üì• INSERCI√ìN</button>
                    <button type="button" class="btn-print" onclick="imprimir('derechos')">üìú DERECHOS</button>
                    <button type="button" class="btn-secondary" onclick="imprimir('const_domicilio')">üè† CONST. DOM.</button>
                    <button type="button" class="btn-secondary" onclick="imprimir('prohibicion')">üö´ PROHIBICION</button>
                    <button type="button" class="btn-secondary" onclick="imprimir('entrega_rodado')">üèçÔ∏è ENT. RODADO</button>
                    <button type="button" class="btn-secondary" onclick="imprimir('nota_medico')">‚öïÔ∏è NOTA MEDICO</button>
                    <button type="button" class="btn-secondary" onclick="imprimir('notificacion')">üîî NOTIFICACION</button>
                    <button type="button" class="btn-secondary" onclick="imprimir('entrega_pert')">üì¶ ENT. PERTEN.</button>
                    <button type="button" class="btn-tool" style="background: #2563eb;" onclick="abrirEditorElevacion()">üìÑ ELEVACI√ìN</button>
                    <button type="button" class="btn-tool" onclick="exportarExcel()">üìä EXCEL</button>
                    <button type="button" class="btn-tool" onclick="document.getElementById('inputExcel').click()">üì• IMPORTAR</button>
                </div>
                <button type="button" onclick="Nuevo()" style="background:#475569; width: 100%;">Sweep üßπ Nuevo FORMULARIO</button>
                <input type="file" id="inputExcel" style="display:none" accept=".xlsx" onchange="leerExcel(this)">
            </div>
            
            <div id="contenedorEditor" style="display:none; margin-top:20px; width:100%;">
                <div class="card" style="background: #f1f5f9;">
                    <div class="section-title" style="color: #0f172a; border-color:#0f172a">üìù EDITOR DE ELEVACI√ìN</div>
                    <div id="editorElevacion" contenteditable="true"></div>
                    <div class="button-group" style="margin-top:15px;">
                        <button type="button" class="btn-ia" onclick="mejorarConIA()">‚ú® MEJORAR REDACCI√ìN (IA)</button>
                        <button type="button" class="btn-save" onclick="prepararImpresionElevacion()">üñ®Ô∏è CONFIRMAR E IMPRIMIR</button>
                        <button type="button" class="btn-secondary" onclick="document.getElementById('contenedorEditor').style.display='none'">‚ùå CANCELAR</button>
                    </div>
                </div>
            </div>
        </form>

        <div class="card">
            <div class="section-title">üìã REGISTROS (M√âDICO | DOM | ANT | FOTO | PLAZOS)</div>
            <div class="table-container">
                <table id="tablaRegistros">
                    <thead>
                        <tr>
                            <th>APREHENDIDO</th>
                            <th>DNI</th>
                            <th>‚è±Ô∏è TIEMPO</th>
                            <th class="check-cell">ü©∫</th>
                            <th class="check-cell">üè†</th>
                            <th class="check-cell">üìú</th>
                            <th class="check-cell">üì∏</th>
                            <th>ACCIONES</th>
                        </tr>
                    </thead>
                    <tbody id="cuerpoTabla"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="printArea"></div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDGXXj11PQJPCea2v_YmyNg0cR2U0GqxkA",
            authDomain: "comisaria2da-cc0ea.firebaseapp.com",
            projectId: "comisaria2da-cc0ea",
            storageBucket: "comisaria2da-cc0ea.firebasestorage.app",
            messagingSenderId: "317044163335",
            appId: "1:317044163335:web:ec6f0209fbbd03225b3ba2",
            measurementId: "G-CYJXQ8H9TH"
        };

        firebase.initializeApp(firebaseConfig);
        const dbCloud = firebase.firestore();

        let db = [];
        let indexEdit = null;

        dbCloud.collection("registros").orderBy("timestamp", "desc")
            .onSnapshot((snapshot) => {
                db = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTabla();
            });

        // --- L√ìGICA DE WHATSAPP ---
        function procesarWhatsApp() {
            const rawText = document.getElementById('rawInput').value;
            if (!rawText) return;

            const lineas = rawText.split('\n').map(l => l.trim()).filter(l => l !== "");
            let idxNombre = lineas.findIndex(l => !l.toLowerCase().includes("buenos") && !l.toLowerCase().includes("subof") && !l.toLowerCase().includes("cria"));
            if (idxNombre === -1) idxNombre = 0;

            document.getElementById('nombreCompleto').value = lineas[idxNombre].toUpperCase();
            
            const lineaInfo = lineas[idxNombre + 1] || "";
            if (lineaInfo.toUpperCase().includes("A/S")) {
                document.getElementById('nacionalidad').value = "ARGENTINO";
                document.getElementById('estadoCivil').value = "SOLTERO";
                const edad = lineaInfo.match(/\d+/);
                if (edad) document.getElementById('edad').value = edad[0];
            }

            const lineaDni = lineas[idxNombre + 2] || "";
            document.getElementById('dni').value = lineaDni.replace(/\./g, "").match(/\d+/) ? lineaDni.replace(/\./g, "").match(/\d+/)[0] : "";

            const lineaNac = lineas[idxNombre + 3] || "";
            if (lineaNac.includes("/")) {
                const p = lineaNac.split("/");
                let anio = p[2].length === 2 ? (parseInt(p[2]) > 30 ? "19"+p[2] : "20"+p[2]) : p[2];
                document.getElementById('fechaNac').value = `${anio}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`;
            }

            if (lineas[idxNombre + 4]) document.getElementById('domicilio').value = lineas[idxNombre + 4].toUpperCase();
            if (lineas[idxNombre + 5]) document.getElementById('padre').value = lineas[idxNombre + 5].toUpperCase();
            if (lineas[idxNombre + 6]) document.getElementById('madre').value = lineas[idxNombre + 6].toUpperCase();

            let antArr = [];
            lineas.forEach(l => {
                const UP = l.toUpperCase();
                if (l.match(/\d+\/\d+\/\d+/)) {
                    antArr.push(UP);
                    if (UP.includes(" FF")) document.getElementById('fiscalia').value = "FISCAL√çA DE FLAGRANCIA";
                }
                if (l.includes(".") && l.split(".").length >= 3 && !l.includes("/")) {
                    document.getElementById('nroPrio').value = l.replace(/[^\d.]/g, "");
                }
                if (UP.includes("NO CAPTURA") || UP.includes("NI/NC/SS") || UP.includes("NO POSEE CAPTURA")) {
                    document.getElementById('capturas').value = "NO POSEE IMPEDIMENTOS LEGALES VIGENTES";
                }
                if (UP.includes(" FF")) document.getElementById('fiscalia').value = "FISCAL√çA DE FLAGRANCIA";
            });
            if (antArr.length > 0) document.getElementById('antecedentes').value = antArr.join('\n');
            
            document.getElementById('rawInput').value = "";
            alert("‚úÖ DATOS INTERPRETADOS");
        }

        // --- L√ìGICA DE IA ---
        async function mejorarConIA() {
            const API_KEY = "TU_API_KEY_AQU√ç"; 
            const editor = document.getElementById('editorElevacion');
            const original = editor.innerText;
            if (API_KEY === "TU_API_KEY_AQU√ç") return alert("Configure la clave API primero.");

            try {
                editor.innerHTML = "‚åõ TRABAJANDO...";
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Redacta de forma profesional y legal para una elevaci√≥n a fiscal√≠a argentina: ${original}` }] }]
                    })
                });
                const data = await res.json();
                editor.innerText = data.candidates[0].content.parts[0].text;
            } catch (e) {
                alert("Error de IA");
                editor.innerText = original;
            }
        }

        // --- SEM√ÅFORO DE PLAZOS ---
        function getStatusClass(timestamp) {
            if (!timestamp) return "";
            const diff = (new Date() - timestamp.toDate()) / 3600000;
            if (diff > 12) return "status-danger";
            if (diff > 6) return "status-warning";
            return "status-ok";
        }

        function getTiempo(timestamp) {
            if (!timestamp) return "--:--";
            const diffMs = (new Date() - timestamp.toDate());
            const h = Math.floor(diffMs / 3600000);
            const m = Math.floor((diffMs % 3600000) / 60000);
            return `${h}h ${m}m`;
        }

        async function actualizarCheck(id, campo, valor) {
            const data = {}; data[campo] = valor;
            await dbCloud.collection("registros").doc(id).update(data);
        }

        async function guardarDato() {
            const campos = document.querySelectorAll('#registroForm input, #registroForm textarea');
            const r = {};
            campos.forEach(c => r[c.id] = c.value.toUpperCase());
            r.timestamp = firebase.firestore.FieldValue.serverTimestamp();

            try {
                if (indexEdit !== null) {
                    await dbCloud.collection("registros").doc(db[indexEdit].id).update(r);
                    indexEdit = null;
                } else {
                    await dbCloud.collection("registros").add(r);
                }
                document.getElementById('registroForm').reset();
                alert("‚úÖ GUARDADO");
            } catch (e) { alert("‚ùå ERROR"); }
        }

        function renderTabla() {
            const tbody = document.getElementById('cuerpoTabla');
            tbody.innerHTML = '';
            const grupos = db.reduce((acc, r) => {
                let fKey = r.timestamp ? r.timestamp.toDate().toLocaleDateString('es-AR') : "HOY";
                if (!acc[fKey]) acc[fKey] = [];
                acc[fKey].push(r);
                return acc;
            }, {});
            Object.keys(grupos).forEach(fecha => {
                const trH = document.createElement('tr');
                trH.innerHTML = `<td colspan="8" class="fecha-header">üìÖ REGISTROS DEL D√çA: ${fecha}</td>`;
                tbody.appendChild(trH);
                grupos[fecha].forEach(r => {
                    const realIdx = db.findIndex(i => i.id === r.id);
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td style="font-weight:bold">${r.nombreCompleto || ''}</td>
                        <td>${r.dni || ''}</td>
                        <td><span class="status-timer ${getStatusClass(r.timestamp)}">${getTiempo(r.timestamp)}</span></td>
                        <td class="check-cell"><input type="checkbox" ${r.checkMed?'checked':''} onchange="actualizarCheck('${r.id}','checkMed',this.checked)"></td>
                        <td class="check-cell"><input type="checkbox" ${r.checkDom?'checked':''} onchange="actualizarCheck('${r.id}','checkDom',this.checked)"></td>
                        <td class="check-cell"><input type="checkbox" ${r.checkAnt?'checked':''} onchange="actualizarCheck('${r.id}','checkAnt',this.checked)"></td>
                        <td class="check-cell"><input type="checkbox" ${r.checkFoto?'checked':''} onchange="actualizarCheck('${r.id}','checkFoto',this.checked)"></td>
                        <td>
                            <button onclick="cargar(${realIdx})" style="background:var(--warning); padding:4px 8px;">EDITAR</button>
                            <button onclick="eliminarDato(${realIdx})" style="background:var(--danger); padding:4px 8px;">X</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            });
        }

        function cargar(i) {
            indexEdit = i;
            const r = db[i];
            Object.keys(r).forEach(k => { if(document.getElementById(k)) document.getElementById(k).value = r[k]; });
            document.getElementById('contenedorEditor').style.display = 'none';
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        async function eliminarDato(i) {
            if(confirm("¬øELIMINAR?")) await dbCloud.collection("registros").doc(db[i].id).delete();
        }

        function Nuevo() { document.getElementById('registroForm').reset(); indexEdit = null; }

        function fF(f) { return f ? f.split('-').reverse().join('/') : ""; }
        function getHoy() { return `ROSARIO, ${new Date().toLocaleDateString('es-AR', {weekday:'long', day:'numeric', month:'long', year:'numeric'})}`.toUpperCase(); }

        function abrirEditorElevacion() {
            const r = indexEdit !== null ? db[indexEdit] : null;
            if(!r) return alert("SELECCIONE REGISTRO");
            const editor = document.getElementById('editorElevacion');
            if(r.elevacionPersonalizada) {
                editor.innerHTML = r.elevacionPersonalizada;
            } else {
                editor.innerHTML = `
                    <div style="font-family: Arial; font-size: 11pt; line-height: 1.5;">
                        <div style="text-align: right;">${getHoy()}.-</div>
                        <p>MINISTERIO PUBLICO DE LA ACUSACION<br>FISCALIA DE FLAGRANCIA Y TURNO.<br>‚Äú FISCAL‚Äù</p>
                        <p>A.U.O.P.<br>Cr√≠a. 2da.<br>Nota Nro.________/26.- &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OBJETO: ELEVAR ACTUACIONES<br>Ref. CAUSA ‚Äú${r.nroCausa || ''}‚Äù/26</p>
                        <p style="text-align: justify; text-indent: 3cm;">Por medio de la presente elevo a Usted, en referencia a actuaciones por un hecho caratulado a prima facie "${r.causaFinal || ''}", en donde resultare victima la llamada "${r.victima || ''}" e imputado el llamado "${r.nombreCompleto || ''}" para su conocimiento, consideraci√≥n y dem√°s fines legales que estime corresponder.-</p>
                        <br><p>Saludo a Ud. muy atte.</p><br><br>
                        <div style="text-align: right;">${r.sumariante || ''}<br>COMISARIA 2¬∞ URII</div>
                    </div>`;
            }
            document.getElementById('contenedorEditor').style.display = 'block';
        }

        async function prepararImpresionElevacion() {
            const contenido = document.getElementById('editorElevacion').innerHTML;
            await dbCloud.collection("registros").doc(db[indexEdit].id).update({ elevacionPersonalizada: contenido });
            document.getElementById('printArea').innerHTML = `<div class="print-doc">${contenido}</div>`;
            window.print();
        }

        function imprimir(tipo) {
            const r = indexEdit !== null ? db[indexEdit] : db[0];
            if(!r) return;
            const area = document.getElementById('printArea');
            const fechaN = fF(r.fechaNac);
            const hoy = getHoy();
            if(tipo === 'ficha') {
                area.innerHTML = `<div class="print-ficha"><div>${r.nombreCompleto}</div><div style="margin-bottom:1.5em"></div><div>${r.padre}</div><div>${r.madre}</div><div>${r.nacionalidad}</div><div>${r.provincia}</div><div>${r.ciudad}</div><div>${fechaN} &nbsp; ${r.edad} A√ëOS</div><div>D.N.I. N¬∫ ${r.dni}</div><div style="margin-bottom:1.5em"></div><div>${r.domicilio}</div></div>`;
            }
            else if(tipo === 'planilla') {
                area.innerHTML = `<div class="print-planilla"><div class="p-fecha">${hoy}</div><h2 style="text-align:center; text-decoration:underline; margin-bottom:15px; font-size:12pt">PLANILLA DE FILIACION PRONTUARIAL</h2><p><strong>APELLIDO Y NOMBRES:</strong> <span class="planilla-linea">${r.nombreCompleto}</span></p><p><strong>APODO / ALIAS:</strong> <span class="planilla-linea">${r.apodo}</span></p><p><strong>HIJO DE (PADRE):</strong> <span class="planilla-linea">${r.padre}</span></p><p><strong>HIJO DE (MADRE):</strong> <span class="planilla-linea">${r.madre}</span></p><p><strong>NACIONALIDAD:</strong> <span class="planilla-linea">${r.nacionalidad}</span></p><p><strong>ESTADO CIVIL:</strong> <span class="planilla-linea">${r.estadoCivil}</span></p><p><strong>FECHA DE NACIMIENTO:</strong> <span class="planilla-linea">${fechaN}</span></p><p><strong>EDAD:</strong> <span class="planilla-linea">${r.edad} A√ëOS</span></p><p><strong>DOMICILIADO EN CALLE:</strong> <span class="planilla-linea">${r.domicilio}</span></p><p><strong>DOCUMENTO TIPO:</strong> <span class="planilla-linea">D.N.I N¬∞ ${r.dni}</span></p><p><strong>PRIO N¬∞:</strong> <span class="planilla-linea">${r.nroPrio}</span></p><div style="margin-top:10px"><strong>CAPTURAS Y/O PARADEROS:</strong><pre style="white-space: pre-wrap; font-family: Arial; font-size: 10pt; margin-top: 5px; text-transform: uppercase;">${r.capturas}</pre></div><div style="margin-top:10px"><strong>ANTECEDENTES PENALES:</strong><pre style="white-space: pre-wrap; font-family: Arial; font-size: 10pt; margin-top: 5px; text-transform: uppercase;">${r.antecedentes}</pre></div><p style="font-size:9pt; margin-top:15px"><strong>NOTA:</strong> DATOS SUMINISTRADOS VIA TELEFONICA POR OFICINA 10 PDI.</p><div class="p-firma">${r.sumariante}<br>COMISARIA 2¬∞ URII</div></div>`;
            }
            else if(tipo === 'cotejo') {
                area.innerHTML = `
                    <div class="print-doc">
                        <div class="p-fecha">${hoy}.-</div>
                        <p><strong>SE√ëOR JEFE DE DACTILOSCOPIA<br>DIVISION CRIMINALISTICA - UNIDAD REGIONAL II</strong><br>S________________/___________________D</p>
                        <div class="p-ref">
                            <div>A.U.O.P.- CR√çA. 2¬∞<br>NOTA N¬∫ ________/26-</div>
                            <div>OBJETO: COTEJO DE FICHAS</div>
                        </div>
                        <div class="p-cuerpo">POR MEDIO DE LA PRESENTE, REMITO A UD. UN JUEGO DE FICHAS DACTILOSC√ìPICAS DE QUIEN DICE LLAMARSE ${r.nombreCompleto}, DE NACIONALIDAD ${r.nacionalidad}, NACIDO EL D√çA ${fechaN}, DE ${r.edad} A√ëOS DE EDAD, TITULAR DEL D.N.I. N¬∫ ${r.dni}, HIJO DE ${r.padre} Y DE ${r.madre}, CON DOMICILIO EN CALLE ${r.domicilio} DE LA CIUDAD DE ${r.ciudad}, PROVINCIA DE ${r.provincia}, A LOS FINES DE QUE SE REALICE EL CORRESPONDIENTE COTEJO DE FICHAS, HACIENDO CONSTAR QUE EL MISMO SE ENCUENTRA DEMORADO POR EL HECHO ${r.causaIngreso}, QUE SE INVESTIGA A DISPOSICI√ìN DEL FISCAL DE FLAGRANCIA EN TURNO ${r.fiscalia}, EN RELACI√ìN A LA CAUSA ${r.causaFinal}.</p>
                        <div class="p-firma" style="margin-top: 4cm;">SALUDA A UD. ATTE.<br><br><br>${r.sumariante}<br>COMISARIA 2¬∞ URII</div>
                    </div>`;
            }
            else if(tipo === 'afis') {
                area.innerHTML = `
                    <div class="print-doc">
                        <div class="p-fecha">${hoy}.-</div>
                        <p><strong>SE√ëOR JEFE SECCION AFIS, U.R II</strong><br>S________________/___________________D</p>
                        <div class="p-ref">
                            <div>A.U.O.P.- CR√çA. 2¬∞<br>NOTA N¬∫ ________/26-</div>
                            <div>OBJETO: COTEJO DE FICHAS</div>
                        </div>
                        <div class="p-cuerpo">POR MEDIO DE LA PRESENTE, REMITO A UD. UN JUEGO DE FICHAS DACTILOSC√ìPICAS DE QUIEN DICE LLAMARSE ${r.nombreCompleto}, DE NACIONALIDAD ${r.nacionalidad}, NACIDO EL D√çA ${fechaN}, DE ${r.edad} A√ëOS DE EDAD, TITULAR DEL D.N.I. N¬∫ ${r.dni}, HIJO DE ${r.padre} Y DE ${r.madre}, CON DOMICILIO EN CALLE ${r.domicilio} DE LA CIUDAD DE ${r.ciudad}, PROVINCIA DE ${r.provincia}, A LOS FINES DE QUE SE REALICE EL CORRESPONDIENTE COTEJO DE FICHAS, HACIENDO CONSTAR QUE EL MISMO SE ENCUENTRA DEMORADO, QUE SE INVESTIGA A DISPOSICI√ìN DEL FISCAL DE FLAGRANCIA EN TURNO ${r.fiscalia}.</p>
                        <p style="text-align: center; font-weight: bold; margin-top: 15px;">SE ESPERA PRONTA RESPUESTA AL CORREO OFICIAL CONSMPA-UR2CRIA2@SANTAFE.GOV.AR.-</p>
                        <p style="text-align: center; font-weight: bold; margin-top: 5px;">NO SIENDO PARA M√ÅS RUEGO DARLE A LA PRESENTE CAR√ÅCTER DE URGENTE DESPACHO.-</p>
                        <div class="p-firma" style="margin-top: 3cm;">SALUDA A UD. ATTE.<br><br><br>${r.sumariante}<br>COMISARIA 2¬∞ URII</div>
                    </div>`;
            }
            else if(tipo === 'insercion') {
                area.innerHTML = `
                    <div class="print-doc">
                        <div class="p-fecha">${hoy}.-</div>
                        <p><strong>SE√ëOR JEFE DE DACTILOSCOPIA<br>DIVISION CRIMINALISTICA - UNIDAD REGIONAL II</strong></p>
                        <div class="p-ref">
                            <div>A.U.O.P.- CR√çA. 2¬∞<br>NOTA N¬∫ ________/26-</div>
                            <div style="text-align:right">OBJETO: INSERCI√ìN DE CAUSA Y<br>PLANILLA PRONTUARIAL<br>CAUSA N¬∫ ${r.nroCausa}</div>
                        </div>
                        <div class="p-cuerpo">POR MEDIO DE LA PRESENTE, REMITO A UD. UN JUEGO DE FICHAS DACTILOSC√ìPICAS DE QUIEN DICE LLAMARSE <strong>${r.nombreCompleto}</strong>, NACIDO EN <strong>${fechaN}</strong>, D.N.I. N¬∫ <strong>${r.dni}</strong>, HIJO DE <strong>${r.padre}</strong> Y DE <strong>${r.madre}</strong>, CON DOMICILIO EN CALLE <strong>${r.domicilio}</strong> A LOS FINES DE QUE SE CLASIFIQUEN LAS MISMAS PARA LA CORRESPONDIENTE <strong>INSERCI√ìN DE CAUSA Y CONFECCI√ìN DE PLANILLA PRONTUARIAL</strong>, HACIENDO CONSTAR QUE EL CAUSANTE SE ENCUENTRA DEMORADO EN ESTA DEPENDENCIA POR EL HECHO A PRIMA FACIE DE <strong>"${r.causaFinal}"</strong>, A DISPOSICI√ìN DEL FISCAL DE FLAGRANCIA Y TURNO <strong>${r.fiscalia}</strong>.-</div>
                        <p style="text-indent: 4cm">SE ADJUNTA A LA PRESENTE NOTA COPIA DE ACTA DE PROCEDIMIENTO Y ACTA CIRCUNSTANCIADA.</p>
                        <div class="p-firma" style="margin-top: 4cm;">SALUDA A UD. ATTE.<br><br><br>${r.sumariante}<br>COMISARIA 2¬∞ URII</div>
                    </div>`;
            }
            else if(tipo === 'derechos') {
                area.innerHTML = `
                    <div class="print-acta">
                        <div class="acta-titulo">ACTA DE CONOCIMIENTO DE DERECHOS DEL IMPUTADO</div>
                        <p><strong>Derechos del imputado - Art√≠culo 100 y 101 del C√≥digo Procesal Penal</strong></p>
                        <p>Toda persona detenida o indicada como autor o part√≠cipe de un hecho delictivo cuenta con los siguientes derechos, los cuales puede hacer valer en cualquier momento de la investigaci√≥n y hasta la terminaci√≥n del proceso seguido en su contra:</p>
                        <div class="acta-punto">. ÔÄ≠	Derecho a elegir un abogado defensorde su confianza, y en caso de no ejercer su derecho ser√° asistido por un defensor de oficio integrante del Servicio P√∫blico Provincial de la Defensa Penal (SPPDP). Asimismo, en √©ste momento se le solicitar√° que designe abogado defensor o que manifieste su voluntad de ser asistido por el SPPDP.</div>
                        <div class="acta-punto">. ÔÄ≠	Derecho a conferenciar en forma privada y librecon su letrado defensor, antes de prestar declaraci√≥n o realizar un acto que requiera su presencia.</div>
                        <div class="acta-punto">. ÔÄ≠	Que puede hacer uso de su derecho constitucional de no declarar sin que ello signifique una presunci√≥n en su contra y su declaraci√≥n ser√° v√°lida siempre que este presente su defensor.</div>
                        <div class="acta-punto">. ÔÄ≠	Que tiene derecho a solicitar al fiscal o fiscal adjunto que le haga saber los hechos que se le atribuyen, su calificaci√≥n legal y las evidencias en su contra.</div>
                        <div class="acta-punto">. ÔÄ≠	Que tiene derecho a solicitar que se practiquen diligencias probatorias que estime de utilidad.</div>
                        
                        <p>En Rosario, a la fecha <strong>${hoy}</strong>, ante quien suscribe, se notifica de los derechos a <strong>${r.nombreCompleto}</strong>, nacionalidad <strong>${r.nacionalidad}</strong>, nacido el d√≠a <strong>${fechaN}</strong>, D.N.I. N¬∫ <strong>${r.dni}</strong>, hijo de <strong>${r.padre}</strong> y de <strong>${r.madre}</strong>, domiciliado en calle <strong>${r.domicilio}</strong>. Manifiesta que <strong>SI SABE LEER Y ESCRIBIR</strong>, y se desempe√±a como <strong>DESOCUPADO</strong>.</p>
                        
                        <p>Consultado sobre abogado defensor refiere que: <strong>SI, A POSTERIOR DESIGNARA UNO DE SU CONFIANZA</strong>.</p>
                        
                        <p>Se le notifica que se encuentra imputado por el delito de ‚Äú<strong>"${r.causaFinal}"</strong>‚Äù aprehendido el <strong>${fechaApreh}</strong>; a disposici√≥n del <strong>${r.fiscalia}</strong>, quien ordena que el mismo <strong>${r.orden}</strong>.</p>
                        
                        <p>En este acto se hace entrega de una copia de la presente acta al imputado.</p>
                        <div class="p-firma" style="margin-top:20px">${r.sumariante}<br>COMISARIA 2¬∞ URII</div>
                    </div>`;
            }
            else if(tipo === 'const_domicilio') {
                area.innerHTML = `<div class="print-doc"><div class="p-fecha">${hoy}</div><h2 style="text-align:center; text-decoration:underline; font-size:12pt">ACTA DE CONSTITUCI√ìN DE DOMICILIO</h2><div class="p-cuerpo" style="text-align: justify;">En la ciudad de Rosario, a los <strong>${hoy}</strong>, el funcionario Policial Actuante, personal adscripto a la Seccional 2¬∞ de la Polic√≠a de la Provincia de Santa Fe, Unidad Regional II ‚Äì Rosario, a los fines legales que diera lugar hace constar: Que por as√≠ haberlo ordenado el defensor en turno, se manda a comparecer a despacho al llamado <strong>${r.nombreCompleto}</strong>, D.N.I. N¬∫ <strong>${r.dni}</strong>, domiciliado en <strong>${r.domicilio}</strong>, a quien mediante este acto se lo notifica que deber√° presentarse en oficina de defensor√≠a p√∫blica sito  en calle sarmiento 2850, dentro de las 72 horas h√°biles, para regularizar su situaci√≥n de domicilio. Con lo que no siendo para m√°s se da por finalizado el presente acto del que previa lectura y ratificaci√≥n que de por si se hace de su total contenido firma de conformidad y para constancia.</div><div style="margin-top:40px; display:flex; justify-content:space-around; text-align:center;"><div>____________________<br>FIRMA NOTIFICADO</div><div>____________________<br>${r.sumariante}<br>COMISARIA 2¬∞ URII</div></div></div>`;
            }
            else if(tipo === 'prohibicion') {
                area.innerHTML = `
                    <div class="print-doc">
                        <div class="p-fecha">${hoy}</div>
                        <h2 style="text-align:center; text-decoration:underline; margin-bottom: 15px; font-size:12pt">ACTA DE NOTIFICACI√ìN PROHIBICION DE ACERCAMIENTO</h2>
                        <div class="p-cuerpo" style="text-align: justify;">
                        En Rosario a los <strong>${hoy}</strong>, el personal policial actuante numerario de Seccional 2da. de polic√≠a U.R. II hago constar que se manda a comparecer despacho al llamado <strong>${r.nombreCompleto}</strong>, D.N.I. N¬∫ <strong>${r.dni}</strong>, a quien en este acto por ORDEN DE LA FISCAL EN TURNO <strong>${r.fiscalia}</strong>, se procede a notificar de   PROHIBICI√ìN DE ACERCAMIENTO AL DOMICILIO POR 72 HS E IMPEDIMENTO DE CONTACTO A ${r.victima}</strong>, domicilio en <strong>${r.domicilioVictima}</strong>. Consultado si entiende lo expuesto el mismo responde que SI. Se hace entrega de una copia de acta de notificaci√≥n. Con lo que no siendo para m√°s, se da por finalizada la presente de la que previa lectura y ratificaci√≥n de su contenido firma el llamado en conformidad y para constancia ante mi quien suscribo y certifico.-
                        </div>
                        <div class="p-firma" style="margin-top: 40px;">${r.sumariante}<br>COMISARIA 2¬∞ URII</div>
                    </div>`;
            }
            else if(tipo === 'entrega_rodado') {
                area.innerHTML = `<div class="print-doc"><div class="p-fecha">${hoy}</div><h2 style="text-align:center; text-decoration:underline; font-size:12pt">ACTA DE ENTREGA DE RODADO</h2><p>Se hace entrega del rodado secuestrado a <strong>${r.nombreCompleto}</strong>, D.N.I. N¬∫ <strong>${r.dni}</strong>.</p><p>DETALLE: <strong>${r.secuestro}</strong></p><div class="p-firma" style="margin-top:4cm">${r.sumariante}<br>COMISARIA 2¬∞ URII</div></div>`;
            }
            else if(tipo === 'nota_medico') {
                area.innerHTML = `<div class="print-doc"><div class="p-fecha">${hoy}</div><p><strong>SE√ëOR JEFE DEL RECONOCIMIENTO M√âDICO POLICIAL</strong></p><p>Solicito examen m√©dico para el demorado <strong>${r.nombreCompleto}</strong>, D.N.I. <strong>${r.dni}</strong>.</p><div class="p-firma" style="margin-top:3cm">${r.sumariante}<br>COMISARIA 2¬∞ URII</div></div>`;
            }
            else if(tipo === 'notificacion') {
                area.innerHTML = `<div class="print-doc"><div class="p-fecha">${hoy}</div><h2 style="text-align:center; text-decoration:underline; font-size:12pt">ACTA DE NOTIFICACI√ìN</h2><p>Se notifica a <strong>${r.nombreCompleto}</strong> de: ___________________________________________________________________</p><div class="p-firma" style="margin-top:5cm">${r.sumariante}</div></div>`;
            }
            else if(tipo === 'entrega_pert') {
                area.innerHTML = `<div class="print-doc"><div class="p-fecha">${hoy}</div><h2 style="text-align:center; text-decoration:underline; margin-bottom: 15px; font-size:12pt">ACTA DE ENTREGA DE PERTENENCIAS</h2><div class="p-cuerpo" style="text-align: justify;">En Rosario a los <strong>${hoy}</strong>, el Funcionario Policial actuante, numerario de esta Comisar√≠a 2¬∫ de Polic√≠a, dependiente de la Agrupaci√≥n Unidades Orden P√∫blico U.R.II, a los fines legales que diera lugar HAGO CONSTAR: Que se manda comparecer a despacho al llamado <strong>${r.nombreCompleto}</strong>, D.N.I. N¬∫ <strong>${r.dni}</strong>, de los elementos en custodia: <strong>${r.pertenencias}</strong> Recibiendo en conformidad. Con lo que no siendo para m√°s se da por finalizado el presente acto, del que previa lectura y ratificaci√≥n de su total e √≠ntegro contenido, firma el causante por ante m√≠ que suscribo y certifico. Firma de conformidad.</div><div style="margin-top:60px; display:flex; justify-content:space-around; text-align:center;"><div>__________________________<br>FIRMA DEL RECEPTOR</div><div>____________________<br>${r.sumariante}<br>COMISARIA 2¬∞ URII</div></div></div>`;
            }

            window.print();
        }


        async function exportarExcel() {
            const wb = new ExcelJS.Workbook();
            const sh = wb.addWorksheet('REGISTRO');
            sh.addRow(["NOMBRE", "DNI", "CAUSA", "FECHA"]);
            db.forEach(r => sh.addRow([r.nombreCompleto, r.dni, r.causaFinal, r.timestamp?r.timestamp.toDate():'']));
            const buffer = await wb.xlsx.writeBuffer();
            saveAs(new Blob([buffer]), "REGISTRO_CRIA2DA.xlsx");
        }

        document.getElementById('nombreCompleto').addEventListener('input', function(e) {
            const busqueda = e.target.value.toUpperCase();
            if (busqueda.length < 5) return; 
            const record = db.find(r => r.nombreCompleto && r.nombreCompleto.includes(busqueda));
            if (record) {
                e.target.style.border = "3px solid var(--danger)";
                if(confirm("‚ö†Ô∏è REINCIDENTE DETECTADO. ¬øCargar sus datos autom√°ticamente?")) cargar(db.indexOf(record));
            } else { e.target.style.border = "1px solid var(--border)"; }
        });

        document.getElementById('fechaNac').addEventListener('change', function(e) {
            if (!e.target.value) return;
            const nac = new Date(e.target.value);
            const h = new Date();
            let edad = h.getFullYear() - nac.getFullYear();
            if (h.getMonth() < nac.getMonth() || (h.getMonth() === nac.getMonth() && h.getDate() < nac.getDate())) edad--;
            document.getElementById('edad').value = edad;
        });

        setInterval(renderTabla, 60000); // Actualiza tabla cada 1 minuto para el sem√°foro
    </script>
</body>
</html>